---
title: "Credit modelling"
author: "Rodrigo Hernández Mota"
header-includes:
   - \usepackage{bbm}
   - \usepackage{amsmath}
date: "12 de septiembre de 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introducción

En el presente documento se publican las tasas de interés propuestas para otorgar / solicitar préstamos entre familiares y conocidos de confianza. 

Este documento es válido para todos los préstamos solicitados durante el mes de **Septiembre**. 

### Especificaciones

Se deberá acordar el monto del préstamo, la tasa de interés y el plazo; sujeto a disponibilidad. Habiendo establecido tales variables, se deberá firmar un pagaré con la información acordada. 

El pagaré deberá contener los requisitos oficiales que validan su legitimidad y por lo tanto estar regulado bajo la _Ley General de Títulos de Crédito_. 

Por simplicidad, se sugiere pagar el pagaré a su vencimiento. En caso de realizar un pago (o pagos) anteriores al fecha límite estipulada, se deberán descontar estos pagos al capital e intereses correspondientes siguendo las reglas de las Matemáticas Financieras. 

```{r general_fuctions, echo=FALSE, warning=FALSE, results='hide', include=FALSE}

library(dplyr)
library(tibble)
library(tidyr)
library(ggplot2)

# Working Directory for Windows...
setwd("~/credit_modelling/personal")
# Working Directory for Linux (Porteus)...
# setwd("~/credit_modelling/personal")

source('finmfun.R')
# Main program ------------------------------------------------------------

main <- function(){
  
  intrate_min <- 0.07
  mr    <- 2000 # monto de referencia
  
  table <- data_frame(lim_inf = numeric(), lim_sup = numeric(),
                          plazo = numeric(), i = numeric())

  for(k in c(2000,4000,6000,8000)){
    for(j in c(1,2,3,4,6,9,12)){
      #s <- 0.015 * ((j/3) - 1) # tasa por falta de disp. de tiempo; penalización horizontal
      #i <- (-12.0567*exp(-0.127368*j) +17.6149) * (1 + k / 10^5)
      i <- (2.62023*exp(0.139728*j) + 3.98684) * (1 + k / 10^5)
      i <- ceiling(i * 10000) / 10000
      if(i/100 < intrate_min){ i <- 100 * intrate_min }
      lim_inf <- k - mr
      table <- add_row(table, lim_inf = lim_inf, lim_sup = k, plazo = j, i = i)
    }
  }
  
  # add payment... 
  f_ls <- apply(table,1,function(x) future_value(x[2], x[4]/100, x[3]))
  inls <- f_ls - table$lim_sup
  table <- add_column(table, f_ls = f_ls, inls = inls)
  
  # order 
  table <- table[order(table$lim_sup),]
  return(table)
}

table <- main()

```

## Requerimientos de capital

Por conveniencia se proponen las siguentes _clasificaciones del capital_ según rangos arbitrarios. 

En la siguente sección se establece una relación entre la clasificación del capital solicitado y la tasa de interés del préstamo. 

\[
 \begin{matrix}
  k_1 \in ( 0, 2000 ] \\
  k_2 \in ( 2000, 4000 ] \\
  k_3 \in ( 4000, 6000 ] \\
  k_4 \in ( 6000, 8000 ]
 \end{matrix}
\]


## Tasas de interés

### Inversionista racional 

Los siguentes comportamientos pueden esperarse de un inversionista racional: 

$\Delta i > 0 \to \Delta k > 0$
Esto significa que dado un cambio positivo en la tasa de interés, un inversionista aumentará el monto $k$ que tiene en inversión. 

$\Delta i > 0 \to \Delta t > 0$
Un aumento en la tasa de interés genera un cambio proporcional en la duración de la inversión / préstamo. 

Dados estos comportamientos, se propone el siguiente modelo para determinar la tasa de interés:

$$ i = j * (1 + r) $$

En donde $i$ es la tasa de interés anual con capitalización mensual, $j$ es el componente temporal y $0<r<1$ es la magnitúd atemporal (penalización por capital).

### Componente temporal 
En la sección anterior se identificó una relación proporcional directa entre la tasa de interés y el tiempo (duración) de la inversión. Por lo tanto, se propone el componente temporal de la siguiente forma:

$$ j = a e ^ { b t } + c$$

Condicionado a $j(1)=7$, $j(8)=12$, $j(12)=18$ en donde ${a,b,c} \in Re$. 

Los valores arbitrarios $j(a)$ en donde $a$ representa el número de meses (duración) del crédito y $j$ es la tasa de interés (sin contemplar la "penalización de capital") son definidos en relación a la tasa de interés de referencia y adecuado al perfil del solicitante. 

Tomando en cuenta los valores y resolviendo el sistema de ecuaciones no lineal se tiene como resultado:

\[
 \begin{matrix}
  a = 2.62023 \\
  b = 0.139728 \\
  c = 3.98684 \\
 \end{matrix}
\]

Sustituyendo en el componente temporal:

$$ j = 2.62023 e ^ { 0.139728 t } + 3.98684 $$

### Penalización de capital
Por cada $1000 del capital solicitado, la tasa aumentará 1 punto base. 

$$(1+r)=(1+k/10^5)$$

En dónde $k$ es el capital. El objetivo de este factor es incentivar la solicitud de crédito para los rangos/clasificaciones más bajas de capital. En este sentido, para un fondo de recursos constante se tiene preferencia otorgar $n$ número de créditos de monto bajo a un mayor número de solicitantes que $m$ solicitudes de crédito de alto monto a un menor número de solictantes (motivo de diversificación). 

### Tasa de interés

Por lo tanto, la tasa de interés es una función del tiempo y del capital. 

$$ i = f(t,k) = (1+r) * j$$
$$ i = (1+k/10^5)( 2.62023 e ^ { 0.139728 t } + 3.98684) $$

### Niveles de tasas de interés 

A continuación se presentan los niveles de tasas en relación la duración (delta, en meses) deseada y a la clasificación del capital solicitado (k). 

Las tasas de interés de este documento son anuales de capitalización mensual. 


\pagebreak

```{r tables, echo=FALSE, message=FALSE}

cat("For delta =", 1)
knitr::kable(filter(table, plazo == 1)[-3][-4][-4])

cat("For delta =", 3)
knitr::kable(filter(table, plazo == 3)[-3][-4][-4])

cat("For delta =", 6)
knitr::kable(filter(table, plazo == 6)[-3][-4][-4])

cat("For delta =", 9)
knitr::kable(filter(table, plazo == 9)[-3][-4][-4])

cat("For delta =", 12)
knitr::kable(filter(table, plazo == 12)[-3][-4][-4])


```

\pagebreak

## Representación Visual

El nivel de tasas de interés se comporta con crecimiento exponencial en el tiempo (duración del crédito) y cambio en amplitud y desplazamiento vertical en función del capital solicitado. 

```{r plot, echo=FALSE, message=FALSE, warning=FALSE}

#Create a custom color scale
library(RColorBrewer)
myColors <- brewer.pal(5,"Set1")
names(myColors) <- levels(table$lim_sup)
colScale <- scale_colour_manual(name = "lim_sup",values = myColors)

ggplot(table, aes(x=plazo, y=i,colour=factor(lim_sup))) + theme_light() +
  geom_point() +
  geom_smooth(se=T,method="lm",formula=y~x*log(x), size = 0.5, alpha = 0.2) +
  xlab("Duartion of loan") + ylab("Annual interest rate with monthly cap.") +
  ggtitle("Interest rate per captial requested and time") + colScale

```


